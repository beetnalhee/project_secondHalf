<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{/layout/template :: template(~{this :: title}, ~{this :: script},  ~{this :: css}, ~{this :: content})}">

<head>
    <title th:fragment="title"> ::: 대화하기 ::: </title>
    <th:block th:fragment="script">
    </th:block>
    <th:block th:fragment="css">
        <link rel="stylesheet" href="/css/index.css">
        <link rel="stylesheet" href="/css/chat.css">
    </th:block>
</head>


<div class="wrapper" th:fragment="content">
    <div id="chat-container">
        <div id="chat-member-list">
            <div>
                <div id="chat-search">
                    <input id="chat-search-bar" type="text" placeholder="찾기">
                    <button id="chat-search-btn" type="submit">검색</button>
                </div>
                <div class="chat-list-area">
                    <ul class="chat-list" id="chatrooms">
                        <th:block th:each="chatDto, status:${chatList}">
                            <li class="chat-member" th:onclick="enterRoom([[${chatDto.roomId}]])">
                                <a th:href="|/chat/room/enter/${chatDto.roomId}|">
                                    <img class="profile-img chat-member-img" src="/img/profile.png">
                                    <div class="chat-list-info">
                                        <div class="chat-list-name" th:text="${chatDto.senderId}"></div>
                                        <div class="chat-list-message">아아</div>
                                    </div>
                                </a>
                            </li>
                        </th:block>
                    </ul>
                </div>
            </div>
        </div>


        <th:block th:if="${roomId != null}">
            <div class="chat-bar">
                <div class="chat-current-member">
                    <img class="profile-img chat-member-img" src="/img/profile.png">
                    <div class="chat-cureent-name member-profile" id="member-profile">
                        김순자 최고
                        <ul class="perid">
                            <li><a href="chat/room/to/싸와디캅망고">1:1 대화하기</a></li>
                            <hr>
                            <li><a href="#">게시글 보기</a></li>
                        </ul>
                    </div>
                </div>
                <div class="chat-history">
                    <ul id="message-list">
                        <th:block th:each="message, status:${messages}">
                            <th:block th:if="${message.senderId} == ${session.loginMember.nickname}">
                            <li class="chat-message-list sent">
                                <div class="message-data">
                                    <div class="message-data-time" th:text="${#dates.format(message.sentAt, 'a hh:mm')}"></div>
                                    <div class="message-data-member" th:text="${message.senderId}"></div>
                                </div>
                                <div class="message-content">
                                    <div class="chat-message-text" th:text="${message.content}"></div>
                                    <img class="profile-img" src="/img/profile.png">
                                </div>
                            </li>
                            </th:block>
                            <th:block th:if="${message.senderId} != ${session.loginMember.nickname}">
                                <li class="chat-message-list received">
                                    <div class="message-data">
                                        <div class="message-data-time" th:text="${#dates.format(message.sentAt, 'a hh:mm')}"></div>
                                        <div class="message-data-member" th:text="${message.senderId}"></div>
                                    </div>
                                    <div class="message-content">
                                        <div class="chat-message-text" th:text="${message.content}"></div>
                                        <img class="profile-img" src="/img/profile.png">
                                    </div>
                                </li>
                            </th:block>
                        </th:block>
<!--                        <th:block th:each="message, status:${messages}">-->
<!--                            <li th:text="${message}"></li>-->
<!--                        </th:block>-->
                    </ul>
                </div>

                <div class="chat-send-box">
<!--                    <form id="message-form" method="post" th:object="${messageForm}"-->
<!--                          th:action="|/chat/sendMessage/${roomId}|">-->
                        <input type="text" class="message-to-send" id="message-input"
                               onkeydown="sendMessageOnEnter()" placeholder="메세지 입력"></input>
                        <button class="message-send-btn" id="send-button" type="submit" onclick="sendMessage()">전송
                        </button>
                        <!--                <button class="message-send-btn" id="send-button" type="submit">전송</button>-->
<!--                    </form>-->
                </div>
            </div>
        </th:block>
        <th:block th:if="${roomId} == null">
            <div class="chat-bar">
            </div>
        </th:block>

    </div>
</div>
<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
<script>
    //대화하기 접속 시 대화 리스트 출력
    document.addEventListener('DOMContentLoaded', function () {
        initWebSocket();
    });

    //웹소켓, 스톰프 설정
    const sock = new SockJS("/wss-stomp");
    const ws = Stomp.over(sock);

    // roomId, sender 설정
    const roomId = localStorage.getItem('wschat.roomId');
    const sender = `[[${session.loginMember.nickname}]]`;
    let room = {};
    let messages = [];

    function initWebSocket() {
        ws.connect({}, function (frame) {
            ws.subscribe("/sub/chat/room/" + roomId, function (message) {
                const recv = JSON.parse(message.body);

                axios.post('/chat/saveMessage', recv)
                    .then(response => {
                        console.log('메세지가 서버로 전송되었습니다.');
                    })
                    .catch(error => {
                        console.log('메세지 전송 중 오류가 발생했습니다.', error);
                    });

                recvMessage(recv);

            });
            ws.send("/pub/chat/message", {}, JSON.stringify({
                type: 'ENTER',
                roomId: roomId,
                senderId: sender
            }));
        }, function (error) {
            alert("error " + error);
        });
    }



    function enterRoom(roomId){
        localStorage.setItem('wschat.roomId', roomId);
    }


    // 방 찾기
    function findRoom() {
        axios.get('/chat/room/' + roomId).then(response => {
            room = response.data;
        });
    }

    // 메세지 수신
    function recvMessage(recv) {
        const messagesListElem = document.querySelector("#message-list");
        const messageItem = document.createElement('li');
        messageItem.className = 'chat-message-list';

        const currentUser = `[[${session.loginMember.nickname}]]`
        if (recv.senderId === currentUser) {
            messageItem.classList.add('sent');
        } else {
            messageItem.classList.add('received');
        }

        const messageData = document.createElement('div');
        messageData.className = 'message-data';

        const messageDataTime = document.createElement('div');
        messageDataTime.className = 'message-data-time';

        const options = {
            hour: 'numeric',
            minute: 'numeric',
            hour12: true,
            timeZone: 'Asia/Seoul'
        };
        messageDataTime.textContent = new Date().toLocaleTimeString('ko-KR', options);

        const messageDataMember = document.createElement('div');
        messageDataMember.className = 'message-data-member';
        messageDataMember.textContent = (recv.senderId);

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const chatMessageText = document.createElement('div');
        chatMessageText.className = 'chat-message-text';
        chatMessageText.textContent = recv.content;

        const profileImg = document.createElement('img');
        profileImg.className = 'profile-img';
        profileImg.src = '/img/profile.png'; // 프로필 이미지 경로

        messageData.appendChild(messageDataTime);
        messageData.appendChild(messageDataMember);

        if (recv.senderId === currentUser) {
            messageContent.appendChild(chatMessageText);
            messageContent.appendChild(profileImg);
        } else {
            messageContent.appendChild(profileImg);
            messageContent.appendChild(chatMessageText);
        }

        messageItem.appendChild(messageData);
        messageItem.appendChild(messageContent);

        messagesListElem.appendChild(messageItem);
        messagesListElem.scrollTop = messagesListElem.scrollHeight;
    }

    // 현재 시간을 가져오는 함수
    function getCurrentTime() {
        return new Date().toISOString(); // ISO 형식의 문자열로 변환
    }


    // 메세지 전송
    function sendMessage() {
        const messageInputElem = document.querySelector("#message-input");
        const message = messageInputElem.value;
        const sentAt = new Date().valueOf(); // 현재 시간 가져오기

        ws.send("/pub/chat/message", {}, JSON.stringify({
            type: 'TALK',
            roomId: roomId,
            senderId: sender,
            content: message,
            sentAt: sentAt
        }));

        // 서버로 메시지를 전송한 후, 데이터베이스에 저장하는 코드
        axios.post('/chat/message', {
            roomId: roomId,
            senderId: sender,
            content: message,
            sentAt: sentAt
        })
            .then(response => {
                console.log('메시지가 성공적으로 전송되었습니다.');
            })
            .catch(error => {
                console.error('메시지 전송 중 오류가 발생했습니다:', error);
            });
        messageInputElem.value = '';
    }

    // 메세지 전송방법, 대화방 연결
    function sendMessageOnEnter() {
        const messageInputElem = document.querySelector("#message-input");
        messageInputElem.onkeydown = function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        };
    }


</script>
</html>
